<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Recipe Book (Nutri-Filter Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .modal {
            display: none;
        }

        .modal.active {
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .recipe-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .prose {
            line-height: 1.6;
        }

        .prose p {
            margin-bottom: 1em;
        }

        .prose ul,
        .prose ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose li {
            margin-bottom: 0.5em;
        }

        .control-label {
            display: block;
            text-sm font-medium text-slate-700 mb-1;
        }

        .control-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            /* 8px 12px */
            border: 1px solid #cbd5e1;
            /* slate-300 */
            border-radius: 0.375rem;
            /* rounded-md */
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .control-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #6366f1;
            /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
            /* ring-indigo-500/25 */
        }

        .filter-btn-action {
            background-color: #4f46e5;
            /* indigo-600 */
            color: white;
        }

        .filter-btn-action:hover {
            background-color: #4338ca;
            /* indigo-700 */
        }

        .filter-btn-clear {
            background-color: #e5e7eb;
            /* gray-200 */
            color: #374151;
            /* gray-700 */
        }

        .filter-btn-clear:hover {
            background-color: #d1d5db;
            /* gray-300 */
        }
    </style>
</head>

<body class="antialiased text-slate-800">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-indigo-600">My Recipe Book</h1>
            <p class="text-slate-600 mt-2 italic">Fueled by caffeine and delicious recipes.</p>
        </header>

        <div class="mb-6 p-4 bg-white rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="nutrientSelect" class="control-label">Nutrient:</label>
                    <select id="nutrientSelect" class="control-input">
                        <option value="">-- Select Nutrient --</option>
                        <option value="Calories">Calories (kcal)</option>
                        <option value="Protein">Protein (g)</option>
                        <option value="Fat">Fat (g)</option>
                        <option value="Carbohydrates">Carbohydrates (g)</option>
                        <option value="Sugar">Sugar (g)</option>
                        <option value="Fiber">Fiber (g)</option>
                        <option value="Sodium">Sodium (mg)</option>
                    </select>
                </div>

                <div>
                    <label for="comparisonType" class="control-label">Compare:</label>
                    <select id="comparisonType" class="control-input">
                        <option value="lte">Less than or equal to (<=)< /option>
                        <option value="gte">Greater than or equal to (>=)</option>
                        <option value="eq">Equal to (=)</option>
                    </select>
                </div>

                <div>
                    <label for="nutrientValue" class="control-label">Value:</label>
                    <input type="number" id="nutrientValue" placeholder="e.g., 500" class="control-input">
                </div>

                <div class="flex flex-col sm:flex-row gap-2 lg:mt-0">
                    <button id="applyNutrientFilter"
                        class="filter-btn-action py-2 px-4 rounded-md text-sm font-medium w-full">Apply</button>
                    <button id="clearNutrientFilter"
                        class="filter-btn-clear py-2 px-4 rounded-md text-sm font-medium w-full">Clear</button>
                </div>
            </div>
            <div class="mt-4">
                <label for="searchInput" class="control-label sr-only">Search Recipes</label>
                <div class="relative w-full">
                    <input type="text" id="searchInput" placeholder="Search by name or ingredients..."
                        class="control-input pl-10">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>


        <div id="recipeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
        <p id="statusMessage" class="text-center text-slate-500 mt-10 text-lg">Loading recipes...</p>
    </div>

    <div id="viewRecipeModal"
        class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div
            class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-start mb-4">
                <h2 id="viewRecipeName" class="text-3xl font-bold text-indigo-600">Recipe Name</h2>
                <button id="closeViewModalBtn" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
            </div>

            <img id="viewImage" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-6 hidden"
                onerror="this.style.display='none'; this.onerror=null;">

            <div class="mb-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-1">Source</h3>
                <a id="viewRecipeURL" href="#" target="_blank" class="text-indigo-500 hover:underline break-all"></a>
                <p id="noRecipeURL" class="text-slate-500 italic hidden">No URL provided.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-sm">
                <div>
                    <p class="font-semibold text-slate-700">Prep Time:</p>
                    <p id="viewPrepTime" class="text-slate-600"></p>
                </div>
                <div>
                    <p class="font-semibold text-slate-700">Cook Time:</p>
                    <p id="viewCookTime" class="text-slate-600"></p>
                </div>
                <div>
                    <p class="font-semibold text-slate-700">Servings:</p>
                    <p id="viewServings" class="text-slate-600"></p>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Ingredients</h3>
                <ul id="viewIngredients" class="list-disc list-inside text-slate-600 space-y-1"></ul>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Instructions</h3>
                <div id="viewInstructions" class="text-slate-600 whitespace-pre-wrap prose"></div>
            </div>

            <div id="viewNutritionSection" class="mb-6 hidden">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Nutrition (approx.)</h3>
                <ul id="viewNutrition" class="list-disc list-inside text-slate-600 space-y-1"></ul>
            </div>

            <div id="viewNotesSection" class="mb-6 hidden">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Notes</h3>
                <p id="viewNotes" class="text-slate-600 italic whitespace-pre-wrap"></p>
            </div>

            <div class="flex justify-end mt-8">
                <button id="closeViewModalBtnBottom"
                    class="py-2 px-5 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-100 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const recipeList = document.getElementById('recipeList');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');

        // Nutrition Filter Elements
        const nutrientSelect = document.getElementById('nutrientSelect');
        const comparisonType = document.getElementById('comparisonType');
        const nutrientValueInput = document.getElementById('nutrientValue');
        const applyNutrientFilterBtn = document.getElementById('applyNutrientFilter');
        const clearNutrientFilterBtn = document.getElementById('clearNutrientFilter');

        // View Modal Elements (same as before)
        const viewRecipeModal = document.getElementById('viewRecipeModal');
        const closeViewModalBtn = document.getElementById('closeViewModalBtn');
        const closeViewModalBtnBottom = document.getElementById('closeViewModalBtnBottom');
        const viewRecipeName = document.getElementById('viewRecipeName');
        const viewRecipeURL = document.getElementById('viewRecipeURL');
        const noRecipeURL = document.getElementById('noRecipeURL');
        const viewPrepTime = document.getElementById('viewPrepTime');
        const viewCookTime = document.getElementById('viewCookTime');
        const viewServings = document.getElementById('viewServings');
        const viewIngredients = document.getElementById('viewIngredients');
        const viewInstructions = document.getElementById('viewInstructions');
        const viewImage = document.getElementById('viewImage');
        const viewNotesSection = document.getElementById('viewNotesSection');
        const viewNotes = document.getElementById('viewNotes');
        const viewNutritionSection = document.getElementById('viewNutritionSection');
        const viewNutrition = document.getElementById('viewNutrition');

        // Application State
        let allRecipes = [];
        let currentNutrientFilter = null; // Object to store {nutrient, type, value}

        // --- Event Listeners ---
        searchInput.addEventListener('input', displayRecipes);
        applyNutrientFilterBtn.addEventListener('click', () => {
            const nutrient = nutrientSelect.value;
            const type = comparisonType.value;
            const value = parseFloat(nutrientValueInput.value);

            if (nutrient && !isNaN(value)) {
                currentNutrientFilter = { nutrient, type, value };
            } else if (nutrient && isNaN(value)) {
                alert("Please enter a valid number for the nutrient value.");
                currentNutrientFilter = null; // Or keep previous valid filter
            }
            else { // If nutrient is not selected or value is invalid, effectively clear
                currentNutrientFilter = null;
            }
            displayRecipes();
        });
        clearNutrientFilterBtn.addEventListener('click', () => {
            currentNutrientFilter = null;
            nutrientSelect.value = "";
            nutrientValueInput.value = "";
            // comparisonType.value = "lte"; // Optionally reset comparison type
            displayRecipes();
        });

        closeViewModalBtn.addEventListener('click', () => viewRecipeModal.classList.remove('active'));
        closeViewModalBtnBottom.addEventListener('click', () => viewRecipeModal.classList.remove('active'));
        document.addEventListener('DOMContentLoaded', loadRecipesAndDisplay);

        // --- Core Functions ---

        /**
         * Fetches recipes from recipes.json and then displays them.
         */
        async function loadRecipesAndDisplay() {
            try {
                const response = await fetch('recipes.json?_=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Could not load recipes.json.`);
                }
                allRecipes = await response.json();
                if (!Array.isArray(allRecipes)) {
                    throw new Error('recipes.json is not a valid JSON array.');
                }
                statusMessage.textContent = '';
                displayRecipes();
            } catch (error) {
                console.error("Error loading recipes:", error);
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.classList.add('text-red-500');
                allRecipes = [];
                displayRecipes();
            }
        }

        /**
         * Parses a specific nutrient value from a recipe's nutrition array.
         * @param {Array<string>} nutritionArray - The array of nutrition strings (e.g., ["Calories: 100 kcal", "Protein: 10g"]).
         * @param {string} nutrientName - The name of the nutrient to extract (e.g., "Calories", "Protein").
         * @returns {number|null} The numerical value of the nutrient, or null if not found/parsable.
         */
        function parseNutritionValue(nutritionArray, nutrientName) {
            if (!nutritionArray || !Array.isArray(nutritionArray)) return null;

            const nutrientNameLower = nutrientName.toLowerCase();
            for (const item of nutritionArray) {
                if (typeof item !== 'string') continue;
                const itemLower = item.toLowerCase();
                if (itemLower.startsWith(nutrientNameLower)) {
                    // Regex to find the first number (integer or decimal)
                    const match = item.match(/:\s*([\d.]+)/) || item.match(/([\d.]+)/); // Try with colon first, then any number
                    if (match && match[1]) {
                        return parseFloat(match[1]);
                    }
                }
            }
            return null; // Nutrient not found or value not parsable
        }


        /**
         * Displays recipes on the page, filtered by search term and nutrition criteria.
         */
        function displayRecipes() {
            recipeList.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase().trim();
            let recipesToDisplay = [...allRecipes]; // Start with a copy of all recipes

            // Apply Nutrition Filter
            if (currentNutrientFilter && currentNutrientFilter.nutrient && !isNaN(currentNutrientFilter.value)) {
                recipesToDisplay = recipesToDisplay.filter(recipe => {
                    const value = parseNutritionValue(recipe.nutrition, currentNutrientFilter.nutrient);
                    if (value === null) return false; // Recipe doesn't have this nutrient or it's not parsable

                    switch (currentNutrientFilter.type) {
                        case 'lte': return value <= currentNutrientFilter.value;
                        case 'gte': return value >= currentNutrientFilter.value;
                        case 'eq': return value === currentNutrientFilter.value; // Note: floating point equality
                        default: return true;
                    }
                });
            }

            // Apply Search Term Filter (to the already nutrient-filtered list)
            if (searchTerm) {
                recipesToDisplay = recipesToDisplay.filter(recipe => {
                    if (!recipe || typeof recipe.name !== 'string' || !Array.isArray(recipe.ingredients)) {
                        return false;
                    }
                    const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
                    const ingredientsMatch = recipe.ingredients.some(ing => typeof ing === 'string' && ing.toLowerCase().includes(searchTerm));
                    return nameMatch || ingredientsMatch;
                });
            }

            // Update status message
            if (recipesToDisplay.length === 0) {
                statusMessage.classList.remove('hidden');
                let msg = "No recipes found.";
                if (allRecipes.length === 0) msg = 'No recipes loaded from recipes.json.';
                else if (currentNutrientFilter && searchTerm) msg = `No recipes match "${searchTerm}" with the current nutrition filter.`;
                else if (currentNutrientFilter) msg = `No recipes match the current nutrition filter.`;
                else if (searchTerm) msg = `No recipes found for "${searchTerm}".`;
                statusMessage.textContent = msg;
            } else {
                statusMessage.classList.add('hidden');
                statusMessage.textContent = '';
            }

            recipesToDisplay.forEach(recipe => {
                const card = createRecipeCard(recipe);
                recipeList.appendChild(card);
            });
        }

        /**
         * Creates an HTML card element for a single recipe.
         */
        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col justify-between';

            const shortIngredients = Array.isArray(recipe.ingredients) ?
                (recipe.ingredients.slice(0, 3).join(', ') + (recipe.ingredients.length > 3 ? '...' : '')) :
                'Not specified';
            let nutritionSummary = '';
            if (recipe.nutrition && Array.isArray(recipe.nutrition) && recipe.nutrition.length > 0) {
                const calorieInfo = recipe.nutrition.find(n => typeof n === 'string' && n.toLowerCase().includes('calories'));
                if (calorieInfo) {
                    nutritionSummary = `<p class="text-xs text-emerald-600 mt-1">${calorieInfo}</p>`;
                }
            }

            card.innerHTML = `
                <div>
                    ${recipe.imageUrl && !recipe.imageUrl.startsWith('data:image/svg+xml') ? `<img src="${recipe.imageUrl}" alt="${recipe.name}" class="w-full h-40 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('afterbegin', '<div class=\\'w-full h-40 bg-slate-200 rounded-lg mb-4 flex items-center justify-center text-slate-500\\'><p>Image Error</p></div>'); this.onerror=null;">` : `<div class="w-full h-40 bg-slate-200 rounded-lg mb-4 flex items-center justify-center text-slate-500"><p>${recipe.imageUrl && recipe.imageUrl.startsWith('data:image/svg+xml') ? 'Placeholder Image' : 'No Image'}</p></div>`}
                    <h3 class="text-xl font-semibold text-indigo-600 mb-2 truncate" title="${recipe.name || ''}">${recipe.name || 'Untitled Recipe'}</h3>
                    ${recipe.url ? `<a href="${recipe.url}" target="_blank" class="text-sm text-indigo-500 hover:underline break-all block mb-2 truncate" title="${recipe.url}">${recipe.url}</a>` : ''}
                    <p class="text-sm text-slate-600 mb-1"><strong class="font-medium">Ingredients:</strong> ${shortIngredients}</p>
                    <p class="text-sm text-slate-600 mb-1"><strong class="font-medium">Prep:</strong> ${recipe.prepTime || 'N/A'} | <strong class="font-medium">Cook:</strong> ${recipe.cookTime || 'N/A'}</p>
                    ${nutritionSummary}
                </div>
                <div class="mt-4 flex justify-end">
                    <button class="view-btn text-sm bg-sky-500 hover:bg-sky-600 text-white py-2 px-4 rounded-md transition duration-150 w-full sm:w-auto" data-id="${recipe.id}">View Details</button>
                </div>
            `;

            card.querySelector('.view-btn').addEventListener('click', () => openViewModal(recipe.id));
            return card;
        }

        /**
         * Opens the modal to view recipe details.
         */
        function openViewModal(recipeId) {
            const recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe) return;

            viewRecipeName.textContent = recipe.name || 'Recipe Details';

            if (recipe.url) {
                viewRecipeURL.href = recipe.url;
                viewRecipeURL.textContent = recipe.url;
                viewRecipeURL.classList.remove('hidden');
                noRecipeURL.classList.add('hidden');
            } else {
                viewRecipeURL.classList.add('hidden');
                noRecipeURL.classList.remove('hidden');
            }

            viewPrepTime.textContent = recipe.prepTime || 'N/A';
            viewCookTime.textContent = recipe.cookTime || 'N/A';
            viewServings.textContent = recipe.servings || 'N/A';

            viewIngredients.innerHTML = '';
            if (Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
                recipe.ingredients.forEach(ing => {
                    const li = document.createElement('li');
                    li.textContent = ing;
                    viewIngredients.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No ingredients listed.';
                li.className = 'italic text-slate-500';
                viewIngredients.appendChild(li);
            }

            viewInstructions.textContent = recipe.instructions || 'No instructions provided.';

            if (recipe.imageUrl && !recipe.imageUrl.startsWith('data:image/svg+xml')) {
                viewImage.src = recipe.imageUrl;
                viewImage.alt = recipe.name;
                viewImage.classList.remove('hidden');
                viewImage.onerror = function () {
                    this.classList.add('hidden');
                    this.onerror = null;
                };
            } else {
                viewImage.classList.add('hidden');
                viewImage.src = '';
            }

            viewNutrition.innerHTML = '';
            if (recipe.nutrition && Array.isArray(recipe.nutrition) && recipe.nutrition.length > 0) {
                recipe.nutrition.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    viewNutrition.appendChild(li);
                });
                viewNutritionSection.classList.remove('hidden');
            } else {
                viewNutritionSection.classList.add('hidden');
            }

            if (recipe.notes) {
                viewNotes.textContent = recipe.notes;
                viewNotesSection.classList.remove('hidden');
            } else {
                viewNotesSection.classList.add('hidden');
            }

            viewRecipeModal.classList.add('active');
        }

    </script>
</body>

</html>