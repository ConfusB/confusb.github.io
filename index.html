<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Recipe Book (Nutri-Filter Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Tailwind gray-100 */
        }

        .modal {
            display: none;
        }

        .modal.active {
            display: flex;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .recipe-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .prose {
            line-height: 1.6;
        }

        .prose p {
            margin-bottom: 1em;
        }

        .prose ul,
        .prose ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .prose li {
            margin-bottom: 0.5em;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            /* text-sm */
            font-weight: 500;
            /* font-medium */
            color: #334155;
            /* text-slate-700 */
            margin-bottom: 0.25rem;
            /* mb-1 */
        }

        .control-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            /* slate-300 */
            border-radius: 0.375rem;
            /* rounded-md */
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .control-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #6366f1;
            /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
            /* ring-indigo-500/25 */
        }

        .filter-btn-action {
            background-color: #4f46e5;
            /* indigo-600 */
            color: white;
        }

        .filter-btn-action:hover {
            background-color: #4338ca;
            /* indigo-700 */
        }

        .filter-btn-clear {
            background-color: #e5e7eb;
            /* gray-200 */
            color: #374151;
            /* gray-700 */
        }

        .filter-btn-clear:hover {
            background-color: #d1d5db;
            /* gray-300 */
        }

        .google-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            /* rounded-md */
            font-weight: 500;
            /* font-medium */
            transition: background-color 0.15s ease-in-out;
        }

        .google-btn-sign-in {
            background-color: #4285F4;
            color: white;
        }

        .google-btn-sign-in:hover {
            background-color: #3578E5;
        }

        .google-btn-sign-out {
            background-color: #DB4437;
            color: white;
        }

        .google-btn-sign-out:hover {
            background-color: #C23327;
        }

        .google-btn svg {
            margin-right: 0.5rem;
            width: 18px;
            height: 18px;
        }
    </style>
</head>

<body class="antialiased text-slate-800">
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-indigo-600">ARMA Recipe Book</h1>
            <p id="pageSubtitle" class="text-slate-600 mt-2 italic">Fueled by caffeine and delicious recipes.</p>
        </header>

        <div class="my-6 text-center">
            <button id="googleSignInButton" class="google-btn google-btn-sign-in" style="visibility:hidden;">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.19,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.19,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.19,22C17.6,22 21.54,18.33 21.54,12.81C21.54,12.09 21.47,11.61 21.35,11.1V11.1Z">
                    </path>
                </svg>
                Sign in with Google to Sync
            </button>
            <button id="googleSignOutButton" class="google-btn google-btn-sign-out ml-2" style="visibility:hidden;">
                Sign Out
            </button>
            <p id="authStatus" class="text-xs text-slate-500 mt-1"></p>
        </div>

        <div class="mb-6 p-4 bg-white rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="nutrientSelect" class="control-label">Nutrient:</label>
                    <select id="nutrientSelect" class="control-input">
                        <option value="">-- Select Nutrient --</option>
                        <option value="Calories">Calories (kcal)</option>
                        <option value="Protein">Protein (g)</option>
                        <option value="Fat">Fat (g)</option>
                        <option value="Carbohydrates">Carbohydrates (g)</option>
                        <option value="Sugar">Sugar (g)</option>
                        <option value="Fiber">Fiber (g)</option>
                        <option value="Sodium">Sodium (mg)</option>
                    </select>
                </div>

                <div>
                    <label for="comparisonType" class="control-label">Compare:</label>
                    <select id="comparisonType" class="control-input">
                        <option value="lte">Less than or equal to (&lt;=)</option>
                        <option value="gte">Greater than or equal to (&gt;=)</option>
                        <option value="eq">Equal to (=)</option>
                    </select>
                </div>

                <div>
                    <label for="nutrientValue" class="control-label">Value:</label>
                    <input type="number" id="nutrientValue" placeholder="e.g., 500" class="control-input">
                </div>

                <div class="flex flex-col sm:flex-row gap-2 lg:mt-0">
                    <button id="applyNutrientFilter"
                        class="filter-btn-action py-2 px-4 rounded-md text-sm font-medium w-full">Apply</button>
                    <button id="clearNutrientFilter"
                        class="filter-btn-clear py-2 px-4 rounded-md text-sm font-medium w-full">Clear</button>
                </div>
            </div>
            <div class="mt-4">
                <label for="searchInput" class="control-label sr-only">Search Recipes</label>
                <div class="relative w-full">
                    <input type="text" id="searchInput" placeholder="Search by name or ingredients..."
                        class="control-input pl-10">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <div id="recipeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>
        <p id="statusMessage" class="text-center text-slate-500 mt-10 text-lg">Loading recipes...</p>
    </div>

    <div id="viewRecipeModal"
        class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div
            class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-start mb-4">
                <h2 id="viewRecipeName" class="text-3xl font-bold text-indigo-600">Recipe Name</h2>
                <button id="closeViewModalBtn" class="text-slate-500 hover:text-slate-700 text-2xl">&times;</button>
            </div>

            <img id="viewImage" src="" alt="Recipe Image" class="w-full h-64 object-cover rounded-lg mb-6 hidden"
                onerror="this.style.display='none'; this.onerror=null;">

            <div class="mb-4">
                <h3 class="text-lg font-semibold text-slate-700 mb-1">Source</h3>
                <a id="viewRecipeURL" href="#" target="_blank" rel="noopener noreferrer"
                    class="text-indigo-500 hover:underline break-all"></a>
                <p id="noRecipeURL" class="text-slate-500 italic hidden">No URL provided.</p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-sm">
                <div>
                    <p class="font-semibold text-slate-700">Prep Time:</p>
                    <p id="viewPrepTime" class="text-slate-600"></p>
                </div>
                <div>
                    <p class="font-semibold text-slate-700">Cook Time:</p>
                    <p id="viewCookTime" class="text-slate-600"></p>
                </div>
                <div>
                    <p class="font-semibold text-slate-700">Servings:</p>
                    <p id="viewServings" class="text-slate-600"></p>
                </div>
            </div>

            <div class="mb-4 text-sm">
                <p id="viewLastMade" class="text-slate-600"></p>
            </div>
            <button id="viewMadeThisBtn"
                class="mb-6 w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-150">I
                Made This!</button>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Ingredients</h3>
                <ul id="viewIngredients" class="list-disc list-inside text-slate-600 space-y-1"></ul>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Instructions</h3>
                <div id="viewInstructions" class="text-slate-600 whitespace-pre-wrap prose"></div>
            </div>

            <div id="viewNutritionSection" class="mb-6 hidden">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Nutrition (approx.)</h3>
                <ul id="viewNutrition" class="list-disc list-inside text-slate-600 space-y-1"></ul>
            </div>

            <div id="viewNotesSection" class="mb-6 hidden">
                <h3 class="text-xl font-semibold text-slate-700 mb-2">Notes</h3>
                <p id="viewNotes" class="text-slate-600 italic whitespace-pre-wrap"></p>
            </div>

            <div class="flex justify-end mt-8">
                <button id="closeViewModalBtnBottom"
                    class="py-2 px-5 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-100 transition duration-150">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Google API Configuration ---
        const CLIENT_ID = '755819391917-titgt6on0q8puu1qv0e67jguaof4c4j2.apps.googleusercontent.com'; // <<< REPLACE THIS!
        const API_KEY = 'YOUR_GOOGLE_API_KEY_IF_NEEDED'; // Optional, often not needed for Drive with GIS/OAuth tokens
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.appdata'; // App Data Folder scope

        const DATA_FILE_NAME = 'arma_recipe_made_data.json';
        let googleDriveFileId = null;
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // DOM Elements
        const recipeList = document.getElementById('recipeList');
        const searchInput = document.getElementById('searchInput');
        const statusMessage = document.getElementById('statusMessage');
        const nutrientSelect = document.getElementById('nutrientSelect');
        const comparisonType = document.getElementById('comparisonType');
        const nutrientValueInput = document.getElementById('nutrientValue');
        const applyNutrientFilterBtn = document.getElementById('applyNutrientFilter');
        const clearNutrientFilterBtn = document.getElementById('clearNutrientFilter');
        const viewRecipeModal = document.getElementById('viewRecipeModal');
        const closeViewModalBtn = document.getElementById('closeViewModalBtn');
        const closeViewModalBtnBottom = document.getElementById('closeViewModalBtnBottom');
        const viewRecipeName = document.getElementById('viewRecipeName');
        const viewRecipeURL = document.getElementById('viewRecipeURL');
        const noRecipeURL = document.getElementById('noRecipeURL');
        const viewPrepTime = document.getElementById('viewPrepTime');
        const viewCookTime = document.getElementById('viewCookTime');
        const viewServings = document.getElementById('viewServings');
        const viewIngredients = document.getElementById('viewIngredients');
        const viewInstructions = document.getElementById('viewInstructions');
        const viewImage = document.getElementById('viewImage');
        const viewNotesSection = document.getElementById('viewNotesSection');
        const viewNotes = document.getElementById('viewNotes');
        const viewNutritionSection = document.getElementById('viewNutritionSection');
        const viewNutrition = document.getElementById('viewNutrition');
        const viewLastMade = document.getElementById('viewLastMade');
        const pageSubtitle = document.getElementById('pageSubtitle'); // For random subtitle

        const googleSignInButton = document.getElementById('googleSignInButton');
        const googleSignOutButton = document.getElementById('googleSignOutButton');
        const authStatus = document.getElementById('authStatus');

        // Application State
        let allRecipes = [];
        let currentNutrientFilter = null;
        let madeRecipesLog = {};
        const subtitlePhrases = [
            "Fueled by caffeine and delicious recipes.",
            "Adventures in the art of cooking.",
            "Your daily dose of culinary inspiration.",
            "Exploring flavors, one recipe at a time.",
            "Happiness is a homemade meal.",
            "Whipping up wonders in the kitchen.",
            "Crafting delicious memories.",
            "Where every recipe tells a story."
        ];

        // --- Google API Initialization ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    // apiKey: API_KEY, // Often not required if discoveryDocs work or for OAuth flows
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                console.log("GAPI client initialized.");
                updateAuthUiAndLoadInitialData();
            } catch (e) {
                console.error("Error initializing GAPI client:", e);
                authStatus.textContent = "Error initializing Google API. Sync unavailable.";
                loadMadeRecipesLogFromLocalStorage(); // Fallback if GAPI fails
                displayRecipes();
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: gisTokenResponseCallback, // Will be called with the token response
                });
                gisInited = true;
                console.log("GIS initialized.");
                updateAuthUiAndLoadInitialData();
            } catch (e) {
                console.error("Error initializing GIS client:", e);
                authStatus.textContent = "Error initializing Google Sign-In. Sync unavailable.";
                loadMadeRecipesLogFromLocalStorage(); // Fallback if GIS fails
                displayRecipes();
            }
        }

        function updateAuthUiAndLoadInitialData() {
            console.log("updateAuthUiAndLoadInitialData called. gapiInited:", gapiInited, "gisInited:", gisInited); // <<<< ADD THIS
            if (gapiInited && gisInited) {
                googleSignInButton.style.visibility = 'visible';
                googleSignInButton.disabled = false;

                const token = gapi.client.getToken(); // Check if a token is already available (e.g., from previous session)
                if (token && token.access_token) {
                    console.log("Already signed in from previous session.");
                    googleSignInButton.innerText = 'Refresh Sync / Signed In';
                    googleSignOutButton.style.visibility = 'visible';
                    authStatus.textContent = 'Signed in to Google. Attempting to sync...';
                    findOrCreateDataFile().then(() => loadMasterMadeRecipesLog());
                } else {
                    googleSignInButton.innerText = 'Sign in with Google to Sync';
                    googleSignOutButton.style.visibility = 'hidden';
                    authStatus.textContent = 'Sign in to sync "Made" data across devices.';
                    // Load local data while waiting for potential sign-in
                    loadMadeRecipesLogFromLocalStorage();
                    displayRecipes();
                }
            }
        }

        async function gisTokenResponseCallback(tokenResponse) {
            if (tokenResponse.error) {
                console.error('Error from GIS token response:', tokenResponse.error);
                authStatus.textContent = `Sign-in error. Sync uses local storage.`;
                gapi.client.setToken(null); // Ensure any old token is cleared from gapi
                loadMadeRecipesLogFromLocalStorage();
                displayRecipes();
                updateAuthUiAndLoadInitialData(); // Update button states
                return;
            }
            // GIS automatically makes the token available to gapi.client
            // No need for gapi.client.setToken(tokenResponse) explicitly
            console.log('Access Token Acquired via GIS.');
            authStatus.textContent = 'Signed in successfully. Syncing data...';
            updateAuthUiAndLoadInitialData(); // Reflect signed-in state
            await findOrCreateDataFile();
            await loadMasterMadeRecipesLog(); // This will now attempt to load from Drive
        }

        // --- Authentication Handlers ---
        function handleAuthClick() {
             console.log("handleAuthClick called!"); // <<<< ADD THIS
            if (!tokenClient) {
                console.error("Token client not initialized.");
                authStatus.textContent = "Google Sign-In not ready. Please wait or refresh.";
                return;
            }
            if (gapi.client.getToken() === null) { // If not signed in, request access
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else { // If already signed in (token exists), just refresh or re-attempt process
                tokenClient.requestAccessToken({ prompt: '' }); // Will use existing grant
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    googleDriveFileId = null;
                    authStatus.textContent = 'Signed out. Sync uses local storage.';
                    console.log('Signed out from Google.');
                    madeRecipesLog = {};
                    loadMadeRecipesLogFromLocalStorage();
                    displayRecipes();
                    updateAuthUiAndLoadInitialData();
                });
            }
        }

        // --- Google Drive API Functions ---
        async function findOrCreateDataFile() {
            if (!gapi.client.getToken() || !gapi.client.getToken().access_token) {
                console.log("Not authenticated with Google. Skipping Drive file check.");
                return;
            }
            authStatus.textContent = 'Checking Google Drive file...';
            try {
                const response = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    fields: 'files(id, name)',
                    q: `name='${DATA_FILE_NAME}' and trashed=false`
                });
                if (response.result.files && response.result.files.length > 0) {
                    googleDriveFileId = response.result.files[0].id;
                    console.log(`Drive file found: ${DATA_FILE_NAME}, ID: ${googleDriveFileId}`);
                } else {
                    console.log(`Drive file '${DATA_FILE_NAME}' not found. Creating...`);
                    const fileMetadata = { 'name': DATA_FILE_NAME, 'parents': ['appDataFolder'] };
                    const createResponse = await gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: { mimeType: 'application/json', body: JSON.stringify({}) },
                        fields: 'id'
                    });
                    googleDriveFileId = createResponse.result.id;
                    console.log(`Drive file created with ID: ${googleDriveFileId}`);
                }
                authStatus.textContent = 'Drive file ready.';
            } catch (err) {
                console.error("Error finding or creating Drive file:", err);
                authStatus.textContent = "Error with Drive file. Sync uses local storage.";
                googleDriveFileId = null;
            }
        }

        async function loadMadeRecipesLogFromGoogleDrive() {
            if (!googleDriveFileId || !gapi.client.getToken() || !gapi.client.getToken().access_token) {
                console.log("No Drive file ID or not authenticated. Cannot load from Drive.");
                return false;
            }
            authStatus.textContent = 'Loading data from Google Drive...';
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: googleDriveFileId,
                    alt: 'media'
                });
                madeRecipesLog = JSON.parse(response.body || "{}");
                console.log("Data loaded from Google Drive:", madeRecipesLog);
                authStatus.textContent = 'Data synced from Google Drive.';
                return true;
            } catch (err) {
                console.error("Error loading data from Google Drive:", err);
                authStatus.textContent = 'Error loading from Drive. Sync uses local storage.';
                if (err.result && err.result.error && err.result.error.code === 404) {
                    console.log("Drive file not found (404), starting fresh for Drive.");
                    madeRecipesLog = {};
                }
                return false;
            }
        }

        async function saveMadeRecipesLogToGoogleDrive() {
            if (!googleDriveFileId || !gapi.client.getToken() || !gapi.client.getToken().access_token) {
                console.warn("Not signed into Google or no Drive file ID. Cannot save to Drive.");
                return false;
            }
            authStatus.textContent = 'Saving data to Google Drive...';
            try {
                const content = JSON.stringify(madeRecipesLog);
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${googleDriveFileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    headers: { 'Content-Type': 'application/json' }, // Important for media upload
                    body: content
                });
                console.log("Data saved to Google Drive successfully.");
                authStatus.textContent = 'Data saved to Google Drive.';
                return true;
            } catch (err) {
                console.error("Error saving data to Google Drive:", err);
                authStatus.textContent = 'Error saving to Drive. Data saved locally only.';
                return false;
            }
        }

        // --- LocalStorage and Master Data Functions ---
        function loadMadeRecipesLogFromLocalStorage() {
            const storedLog = localStorage.getItem('armaMadeRecipesLog');
            madeRecipesLog = storedLog ? JSON.parse(storedLog) : {};
            console.log("Data loaded from localStorage:", madeRecipesLog);
        }

        function saveMadeRecipesLogToLocalStorage() {
            localStorage.setItem('armaMadeRecipesLog', JSON.stringify(madeRecipesLog));
            console.log("Data saved to localStorage.");
        }

        async function loadMasterMadeRecipesLog() {
            let loadedFromDrive = false;
            if (gapi.client.getToken() && gapi.client.getToken().access_token && googleDriveFileId) {
                loadedFromDrive = await loadMadeRecipesLogFromGoogleDrive();
            }
            if (!loadedFromDrive) {
                loadMadeRecipesLogFromLocalStorage();
            }
            displayRecipes();
        }

        async function saveMasterMadeRecipesLog() {
            let savedToDrive = false;
            if (gapi.client.getToken() && gapi.client.getToken().access_token && googleDriveFileId) {
                savedToDrive = await saveMadeRecipesLogToGoogleDrive();
            }
            if (!savedToDrive) {
                saveMadeRecipesLogToLocalStorage();
            }
        }

        // --- Core App Logic (existing and modified) ---
        function setRandomSubtitle() {
            if (pageSubtitle && subtitlePhrases.length > 0) {
                const randomIndex = Math.floor(Math.random() * subtitlePhrases.length);
                pageSubtitle.textContent = subtitlePhrases[randomIndex];
            }
        }

        async function loadRecipesAndDisplay() {
            statusMessage.textContent = 'Loading recipes...';
            statusMessage.classList.remove('hidden', 'text-red-500');
            try {
                const response = await fetch('recipes.json?_=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Could not load recipes.json.`);
                }
                allRecipes = await response.json();
                if (!Array.isArray(allRecipes)) {
                    allRecipes = [];
                    console.error('recipes.json did not contain a valid JSON array.');
                    throw new Error('Recipe data is not a valid array.');
                }
                // After recipes are loaded, try to load user's "made" data (which might try Drive)
                // This is now handled by updateAuthUiAndLoadInitialData and auth callbacks
                // For now, just display with whatever madeRecipesLog is currently set to
                displayRecipes();
            } catch (error) {
                console.error("Error loading recipes.json:", error);
                statusMessage.textContent = `Error loading recipes: ${error.message}`;
                statusMessage.classList.add('text-red-500');
                allRecipes = [];
                displayRecipes();
            }
        }

        function parseNutritionValue(nutritionArray, nutrientName) {
            if (!nutritionArray || !Array.isArray(nutritionArray)) return null;
            const nutrientNameLower = nutrientName.toLowerCase();
            for (const item of nutritionArray) {
                if (typeof item !== 'string') continue;
                const itemLower = item.toLowerCase();
                if (itemLower.startsWith(nutrientNameLower)) {
                    const match = item.match(/:\s*([\d.]+)/) || item.match(/([\d.]+)/);
                    if (match && match[1]) return parseFloat(match[1]);
                }
            }
            return null;
        }

        function displayRecipes() {
            recipeList.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase().trim();
            let recipesToDisplay = [...allRecipes];

            if (currentNutrientFilter && currentNutrientFilter.nutrient && !isNaN(currentNutrientFilter.value)) {
                recipesToDisplay = recipesToDisplay.filter(recipe => {
                    if (!recipe || !Array.isArray(recipe.nutrition)) return false;
                    const value = parseNutritionValue(recipe.nutrition, currentNutrientFilter.nutrient);
                    if (value === null) return false;
                    switch (currentNutrientFilter.type) {
                        case 'lte': return value <= currentNutrientFilter.value;
                        case 'gte': return value >= currentNutrientFilter.value;
                        case 'eq': return Math.abs(value - currentNutrientFilter.value) < 0.001;
                        default: return true;
                    }
                });
            }

            if (searchTerm) {
                recipesToDisplay = recipesToDisplay.filter(recipe => {
                    if (!recipe || typeof recipe.name !== 'string') return false;
                    const nameMatch = recipe.name.toLowerCase().includes(searchTerm);
                    const ingredientsMatch = Array.isArray(recipe.ingredients) && recipe.ingredients.some(ing => typeof ing === 'string' && ing.toLowerCase().includes(searchTerm));
                    return nameMatch || ingredientsMatch;
                });
            }

            statusMessage.classList.toggle('hidden', recipesToDisplay.length > 0 || allRecipes.length === 0 && statusMessage.textContent.startsWith("Error"));
            if (recipesToDisplay.length === 0 && allRecipes.length > 0) { // Only show "no recipes found" if recipes were actually loaded
                let msg = "No recipes found.";
                if (currentNutrientFilter && searchTerm) msg = `No recipes match "${searchTerm}" with the current nutrition filter.`;
                else if (currentNutrientFilter) msg = `No recipes match the current nutrition filter.`;
                else if (searchTerm) msg = `No recipes found for "${searchTerm}".`;
                statusMessage.textContent = msg;
            } else if (recipesToDisplay.length > 0) {
                statusMessage.textContent = ''; // Clear if recipes are shown
            }


            recipesToDisplay.forEach(recipe => {
                const card = createRecipeCard(recipe);
                recipeList.appendChild(card);
            });
        }

        function createRecipeCard(recipe) {
            const card = document.createElement('div');
            card.className = 'recipe-card bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col justify-between';
            card.dataset.recipeId = recipe.id;

            const shortIngredients = Array.isArray(recipe.ingredients) ?
                (recipe.ingredients.slice(0, 3).join(', ') + (recipe.ingredients.length > 3 ? '...' : '')) :
                'Not specified';

            let nutritionSummary = '';
            if (recipe.nutrition && Array.isArray(recipe.nutrition) && recipe.nutrition.length > 0) {
                const calorieInfo = recipe.nutrition.find(n => typeof n === 'string' && n.toLowerCase().includes('calories'));
                if (calorieInfo) {
                    nutritionSummary = `<p class="text-xs text-emerald-600 mt-1">${calorieInfo}</p>`;
                }
            }

            const logEntry = madeRecipesLog[recipe.id];
            let madeInfoHTML = `<div class="made-info text-xs text-green-600 mt-1 ${logEntry ? '' : 'hidden'}">`;
            if (logEntry) {
                const lastMadeDate = new Date(logEntry.lastMade).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                madeInfoHTML += `<p>Made ${logEntry.count} time(s). Last: ${lastMadeDate}</p>`;
            }
            madeInfoHTML += `</div>`;

            card.innerHTML = `
                <div>
                    ${recipe.imageUrl && !recipe.imageUrl.startsWith('data:image/svg+xml') ? `<img src="${recipe.imageUrl}" alt="${recipe.name || 'Recipe Image'}" class="w-full h-40 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('afterbegin', '<div class=\\'w-full h-40 bg-slate-200 rounded-lg mb-4 flex items-center justify-center text-slate-500\\'><p>Image Error</p></div>'); this.onerror=null;">` : `<div class="w-full h-40 bg-slate-200 rounded-lg mb-4 flex items-center justify-center text-slate-500"><p>${recipe.imageUrl && recipe.imageUrl.startsWith('data:image/svg+xml') ? 'Placeholder Image' : 'No Image'}</p></div>`}
                    <h3 class="text-xl font-semibold text-indigo-600 mb-2 truncate" title="${recipe.name || ''}">${recipe.name || 'Untitled Recipe'}</h3>
                    ${recipe.url ? `<a href="${recipe.url}" target="_blank" rel="noopener noreferrer" class="text-sm text-indigo-500 hover:underline break-all block mb-2 truncate" title="${recipe.url}">${recipe.url}</a>` : ''}
                    <p class="text-sm text-slate-600 mb-1"><strong class="font-medium">Ingredients:</strong> ${shortIngredients}</p>
                    <p class="text-sm text-slate-600 mb-1"><strong class="font-medium">Prep:</strong> ${recipe.prepTime || 'N/A'} | <strong class="font-medium">Cook:</strong> ${recipe.cookTime || 'N/A'}</p>
                    ${nutritionSummary}
                    ${madeInfoHTML}
                </div>
                <div class="mt-4 flex flex-col sm:flex-row gap-2">
                    <button class="view-btn text-sm bg-sky-500 hover:bg-sky-600 text-white py-2 px-4 rounded-md transition duration-150 flex-grow" data-id="${recipe.id}">View Details</button>
                    <button class="made-this-btn text-sm bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md transition duration-150 flex-grow" data-id="${recipe.id}">I Made This!</button>
                </div>
            `;

            card.querySelector('.view-btn').addEventListener('click', () => openViewModal(recipe.id));
            card.querySelector('.made-this-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                markRecipeAsMade(recipe.id);
            });
            return card;
        }

        function openViewModal(recipeId) {
            const recipe = allRecipes.find(r => r.id === recipeId);
            if (!recipe) return;

            viewRecipeModal.dataset.recipeId = recipeId;

            viewRecipeName.textContent = recipe.name || 'Recipe Details';
            if (recipe.url) {
                viewRecipeURL.href = recipe.url;
                viewRecipeURL.textContent = recipe.url;
                viewRecipeURL.classList.remove('hidden');
                noRecipeURL.classList.add('hidden');
            } else {
                viewRecipeURL.classList.add('hidden');
                noRecipeURL.classList.remove('hidden');
            }
            viewPrepTime.textContent = recipe.prepTime || 'N/A';
            viewCookTime.textContent = recipe.cookTime || 'N/A';
            viewServings.textContent = recipe.servings || 'N/A';

            viewIngredients.innerHTML = '';
            if (Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
                recipe.ingredients.forEach(ing => {
                    const li = document.createElement('li');
                    li.textContent = ing;
                    viewIngredients.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No ingredients listed.';
                li.className = 'italic text-slate-500';
                viewIngredients.appendChild(li);
            }
            viewInstructions.textContent = recipe.instructions || 'No instructions provided.';

            if (recipe.imageUrl && !recipe.imageUrl.startsWith('data:image/svg+xml')) {
                viewImage.src = recipe.imageUrl;
                viewImage.alt = recipe.name || 'Recipe Image';
                viewImage.classList.remove('hidden');
                viewImage.onerror = function () { this.classList.add('hidden'); this.onerror = null; };
            } else {
                viewImage.classList.add('hidden');
                viewImage.src = '';
            }

            viewNutrition.innerHTML = '';
            if (recipe.nutrition && Array.isArray(recipe.nutrition) && recipe.nutrition.length > 0) {
                recipe.nutrition.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    viewNutrition.appendChild(li);
                });
                viewNutritionSection.classList.remove('hidden');
            } else {
                viewNutritionSection.classList.add('hidden');
            }

            if (recipe.notes) {
                viewNotes.textContent = recipe.notes;
                viewNotesSection.classList.remove('hidden');
            } else {
                viewNotesSection.classList.add('hidden');
            }

            displayMadeInfoInModal(recipeId); // Update "made" info in modal

            const viewMadeThisBtn = document.getElementById('viewMadeThisBtn');
            // Clone and replace to ensure only one listener, or manage listeners more carefully
            const newViewMadeThisBtn = viewMadeThisBtn.cloneNode(true);
            viewMadeThisBtn.parentNode.replaceChild(newViewMadeThisBtn, viewMadeThisBtn);
            newViewMadeThisBtn.addEventListener('click', () => {
                markRecipeAsMade(recipeId);
            });

            viewRecipeModal.classList.add('active');
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', displayRecipes);
        applyNutrientFilterBtn.addEventListener('click', () => {
            const nutrient = nutrientSelect.value;
            const type = comparisonType.value;
            const value = parseFloat(nutrientValueInput.value);

            if (nutrient && !isNaN(value)) {
                currentNutrientFilter = { nutrient, type, value };
            } else if (nutrient && isNaN(value)) {
                alert("Please enter a valid number for the nutrient value.");
            } else {
                currentNutrientFilter = null;
            }
            displayRecipes();
        });
        clearNutrientFilterBtn.addEventListener('click', () => {
            currentNutrientFilter = null;
            nutrientSelect.value = "";
            nutrientValueInput.value = "";
            searchInput.value = ""; // Also clear search input on full clear
            displayRecipes();
        });

        closeViewModalBtn.addEventListener('click', () => viewRecipeModal.classList.remove('active'));
        closeViewModalBtnBottom.addEventListener('click', () => viewRecipeModal.classList.remove('active'));

        document.addEventListener('DOMContentLoaded', () => {
            setRandomSubtitle();
            googleSignInButton.disabled = true; // Keep disabled until GAPI/GIS loads

            loadMadeRecipesLogFromLocalStorage(); // Load local data first
            loadRecipesAndDisplay(); // Initial display based on local data & recipes.json
            // gapiLoaded() and gisLoaded() will call updateAuthUiAndLoadInitialData()
        });
    </script>
</body>

</html>